/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/array/diff","sap/ui/base/Object","sap/base/util/merge","sap/base/util/deepEqual","sap/m/p13n/SelectionPanel","sap/m/p13n/modules/xConfigAPI","sap/ui/core/Configuration"],function(e,t,n,r,i,a,o){"use strict";var s=t.extend("sap.m.p13n.SelectionController",{constructor:function(e){t.call(this);this._oAdaptationControl=e.control;this._aStableKeys=e.stableKeys||[];if(!this._oAdaptationControl){throw new Error("Always provide atleast a 'control' configuration when creating a new p13n controller!")}this._sTargetAggregation=e.targetAggregation;this._fSelector=e.selector;this._oP13nData=null;this._bLiveMode=false;this._bResetEnabled=false;this._bReorderingEnabled=e.hasOwnProperty("enableReorder")?e.enableReorder:true}});s.prototype.getAdaptationControl=function(){return this._oAdaptationControl};s.prototype.getTargetAggregation=function(){return this._sTargetAggregation};s.prototype.getChangeOperations=function(){return{add:"addItem",remove:"removeItem",move:"moveItem"}};s.prototype.getSelectorForReset=function(){return this._oAdaptationControl};s.prototype.sanityCheck=function(e){return e};s.prototype.initAdaptationUI=function(e){var t=this.mixInfoAndState(e);this._oPanel=this.createUI(t);return Promise.resolve(this._oPanel)};s.prototype.createUI=function(e){var t=new i({showHeader:true,enableCount:true});t.setEnableReorder(this._bReorderingEnabled);return t.setP13nData(e.items)};s.prototype.getCurrentState=function(){var e=[],t=this.getAdaptationControl().getAggregation(this.getTargetAggregation())||[];t.forEach(function(t,n){var r=this._fSelector?this._fSelector({key:t.getId()}):t.getVisible();if(r){e.push({key:t.getId()})}}.bind(this));var n=a.readConfig(this.getAdaptationControl())||{};var r=n.hasOwnProperty("aggregations")?n.aggregations[this._sTargetAggregation]:{};for(var i in r){var o=e.map(function(e){return e.key});var s=o.indexOf(i);var p=r[i].position;var l=r[i].visible!==false;var u=p!==undefined;if(l&&s===-1){e.push({key:i})}if(l&&u&&e.length>0){var c=e.splice(s,1)[0];e.splice(p,0,c);s=p}if(r[i].visible===false&&s>-1){e.splice(s,1)}}return e};s.prototype.getStateKey=function(){return"items"};s.prototype.getDelta=function(e){var t=this._getPresenceAttribute(e.externalAppliance);var n;var i=function(e){return e.hasOwnProperty(t)&&e[t]===false?false:true};n=e.applyAbsolute?e.changedState.filter(i):this._getFilledArray(e.existingState,e.changedState,t).filter(i);this._aStableKeys.forEach(function(e,t){var r=this.arrayToMap(this.getCurrentState());var i=this.arrayToMap(n);var a=r[e]||t-1;if(!i.hasOwnProperty(e)){n.splice(a,0,r[e])}}.bind(this));e.changedState=n;if(r(e.existingState,n)){return[]}else{return this.getArrayDeltaChanges(e)}};s.prototype.getArrayDeltaChanges=function(t){var n=t.existingState;var r=t.changedState;var i=t.control;var a=t.changeOperations.add;var o=t.changeOperations.remove;var s=t.changeOperations.move;var p=t.generator;var l=t.deltaAttributes||[];var u=function(e){var t="";l.forEach(function(n){t=t+e[n]});return t};var c=e(n,r,u);var g=function(e,t){return t.filter(function(t){return t&&t.key===e.key})[0]};var h=[];var f=n.slice(0);c.forEach(function(e){if(e.type==="delete"&&f[e.index]===undefined){f.splice(e.index,1);return}var t,n,u;if(e.type==="insert"){n=g(r[e.index],f);if(n){n.index=f.indexOf(n);f.splice(n.index,1,undefined);h=h.concat(this._createAddRemoveChange(i,o,this._getChangeContent(n,l),p))}}t=e.type==="delete"?f[e.index]:r[e.index];t.index=e.index;if(e.type==="delete"){f.splice(t.index,1)}else{f.splice(t.index,0,t)}if(s){u=h.length;if(u){n=h[u-1];n=n?n.changeSpecificData.content:undefined}if(n&&(n.key||n.name)===t.key&&e.index!=n.index){h.pop();h=h.concat(this._createMoveChange(n.id,n.key||n.name,e.index,s,i,s!=="moveSort",p));return}}h=h.concat(this._createAddRemoveChange(i,e.type==="delete"?o:a,this._getChangeContent(t,l),p))}.bind(this));return h};s.prototype._getChangeContent=function(e,t){var n={};if(e.index>=0){n.index=e.index}t.forEach(function(t){if(e.hasOwnProperty(t)){n[t]=e[t]}});return n};s.prototype._createAddRemoveChange=function(e,t,n){var r={selectorElement:e,changeSpecificData:{changeType:t,content:{key:n.key,targetAggregation:this.getTargetAggregation(),index:n.index,value:t===this.getChangeOperations()["add"]}}};return r};s.prototype._createMoveChange=function(e,t,n,r,i,a){var o={selectorElement:i,changeSpecificData:{changeType:r,content:{key:t,targetAggregation:this.getTargetAggregation(),index:n}}};return o};s.prototype._getPresenceAttribute=function(e){return"visible"};s.prototype.getBeforeApply=function(){return Promise.resolve()};s.prototype.mixInfoAndState=function(e){var t=this.getCurrentState();var n=this.arrayToMap(t);var r=this.prepareAdaptationData(e,function(e,t){var r=n[t.name||t.key];e.visible=this._fSelector?this._fSelector(t):!!r;e.position=r?r.position:-1;return!(t.visible===false||this._aStableKeys.indexOf(t.name||t.key)>-1)}.bind(this));this.sortP13nData({visible:"visible",position:"position"},r.items);r.items.forEach(function(e){delete e.position});return r};s.prototype.getP13nData=function(){return this._oPanel?this._oPanel.getP13nData():this._oAdaptationModel&&this._oAdaptationModel.getProperty("/items")};s.prototype.model2State=false;s.prototype.update=function(e){if(this._oPanel){var t=this.mixInfoAndState(e);this._oPanel.setP13nData(t.items)}else if(this._oAdaptationModel){var n=this.mixInfoAndState(e);this._oAdaptationModel.setProperty("/items",n.items);this._oAdaptationModel.setProperty("/itemsGrouped",n.itemsGrouped)}};s.prototype._getFilledArray=function(e,t,r){var i=n([],e);var a=n([],t);a.forEach(function(e){var t=this.arrayToMap(i);var n=t[e.key];if(!e.hasOwnProperty(r)||e[r]){var a=e.position;if(n){a=a>-1?a:n.position;var o=n.position;i.splice(a,0,i.splice(o,1)[0])}else{a=a>-1?a:i.length;i.splice(a,0,e)}i[a]=e}else if(n){i[n.position][r]=false}}.bind(this));return i};s.prototype.changesToState=function(e){var t=[];e.forEach(function(e){var r=n({},e.changeSpecificData.content);var i=r.index;delete r.index;if(i!==undefined){r.position=i}if(e.changeSpecificData.changeType===this.getChangeOperations()["remove"]){r[this._getPresenceAttribute()]=false}t.push(r)}.bind(this));return t};s.prototype.prepareAdaptationData=function(e,t,n){var r=[];var i=n?{}:null;var a=t instanceof Function;e.getProperties().forEach(function(e){var n={};n.key=e.name||e.key;n.name=e.name||e.key;if(a){var o=t(n,e);if(!o){return}}n.label=e.label||n.key;n.tooltip=e.tooltip;if(i){n.group=e.group?e.group:"BASIC";n.groupLabel=e.groupLabel;i[n.group]=i[n.group]?i[n.group]:[];i[n.group].push(n)}r.push(n)});var o={items:r};if(i){o.itemsGrouped=this._buildGroupStructure(i)}return o};s.prototype._buildGroupStructure=function(e){var t=[];Object.keys(e).forEach(function(n){this.sortP13nData("generic",e[n]);t.push({group:n,groupLabel:e[n][0].groupLabel||sap.ui.getCore().getLibraryResourceBundle("sap.m").getText("p13n.BASIC_DEFAULT_GROUP"),groupVisible:true,items:e[n]})}.bind(this));return t};s.prototype.sortP13nData=function(e,t){var n=e;var r=n.position;var i=n.visible;var a=o.getLocale().toString();var s=window.Intl.Collator(a,{});t.sort(function(e,t){if(e[i]&&t[i]){return(e[r]||0)-(t[r]||0)}else if(e[i]){return-1}else if(t[i]){return 1}else if(!e[i]&&!t[i]){return s.compare(e.label,t.label)}})};s.prototype.arrayToMap=function(e){return e.reduce(function(e,t,n){e[t.key]=t;e[t.key].position=n;return e},{})};s.prototype.destroy=function(){t.prototype.destroy.apply(this,arguments);this._oAdaptationControl=null;this._bLiveMode=null;this._oPanel=null;this._bResetEnabled=null;this._oAdaptationModel=null};return s});