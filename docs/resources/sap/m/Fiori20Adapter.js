/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/base/EventProvider","sap/ui/base/ManagedObjectObserver","sap/ui/core/Core","sap/ui/Device","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,n,a,i,o,r){"use strict";var s=new t,d,g,u;var l=e.extend("HeaderAdapter",{constructor:function(e,t){if(!e||!t){o.error("Cannot initialize: Invalid arguments.");return}this._oHeader=e;this._oStyledPage=null;this._oTitleInfo=null;this._oSubTitleInfo=null;this._oBackButtonInfo=null;this._oAdaptOptions=t}});l.prototype.adapt=function(){var e=this._oAdaptOptions.bStylePage,t=this._oAdaptOptions.bCollapseHeader;if(e){this._toggleStyle("sapF2Adapted",true,true)}this._adaptTitle();this._adaptBackButton();if(t){this._collapseHeader()}return this.getAdaptedContent()};l.prototype.getAdaptedContent=function(){return{oTitleInfo:this._oTitleInfo,oSubTitleInfo:this._oSubTitleInfo,oBackButtonInfo:this._oBackButtonInfo,oStyledPage:this._oStyledPage}};l.prototype._adaptTitle=function(){if(!l._isAdaptableHeader(this._oHeader)||this._oAdaptOptions.bMoveTitle!==true){return false}this._oTitleInfo=this._detectTitle();this._oSubTitleInfo=this._detectSubTitle();var e=!!this._oTitleInfo||!!this._oSubTitleInfo;if(this._oTitleInfo){this._oTitleInfo.oControl.toggleStyleClass("sapF2AdaptedTitle",true)}return e};l.prototype._adaptBackButton=function(){if(!l._isAdaptableHeader(this._oHeader)||this._oAdaptOptions.bHideBackButton!==true){return false}var e,t=false;this._oBackButtonInfo=this._detectBackButton();if(this._oBackButtonInfo){e=this._oBackButtonInfo.oControl.getVisible();this._oBackButtonInfo.oControl.toggleStyleClass("sapF2AdaptedNavigation",e);t=true}return t};l.prototype._toggleStyle=function(e,t,n){var a=this._oHeader.getParent();if(!a){return}this._oStyledPage=a;if(t===true){a.addStyleClass(e,n)}else if(t===false){a.removeStyleClass(e,n)}else if(t===undefined){a.hasStyleClass(e)?a.removeStyleClass(e,n):a.addStyleClass(e,n)}};l._isAdaptableHeader=function(e){if(!e||!_(e,"sap/m/Bar")){return false}var t=e.getParent();return t&&(_(t,"sap/m/Page")||_(t,"sap/m/MessagePage")||_(t,"sap/uxap/ObjectPageHeader"))};l.prototype._detectTitle=function(){var e;if(l._isAdaptableHeader(this._oHeader)){var t=this._oHeader.getContentMiddle();if(t.length===1&&h(t[0])){var n=t[0];e={id:n.getId(),text:n.getText(),oControl:n,sChangeEventId:"_change",sPropertyName:"text"}}}return e};l.prototype._detectSubTitle=function(e){if(_(e,"sap/uxap/ObjectPageHeader")){var t=e.getHeaderTitle();if(t){return{id:t.getId(),text:t.getObjectTitle(),oControl:t,sChangeEventId:"_titleChange",sPropertyName:"objectTitle"}}}};l.prototype._detectBackButton=function(){var e,t;if(l._isAdaptableHeader(this._oHeader)){e=this._oHeader.getContentLeft();if(e.length>0&&_(e[0],"sap/m/Button")&&(e[0].getType()==="Back"||e[0].getType()==="Up"||e[0].getIcon()==="sap-icon://nav-back")){t=e[0];return{id:t.getId(),oControl:t,sChangeEventId:"_change",sPropertyName:"visible"}}}};l.prototype._collapseHeader=function(){var e=this._oTitleInfo,t=this._oBackButtonInfo,n,a,i,o,r,s,d;if(l._isAdaptableHeader(this._oHeader)){n=this._oHeader.getContentLeft();a=this._oHeader.getContentMiddle();i=this._oHeader.getContentRight();o=n.length===1&&(v(n[0])||t);r=a.length===1&&(v(a[0])||e);s=i.length===1&&v(i[0]);d=(n.length===0||o)&&(a.length===0||r)&&(i.length===0||s);this._toggleStyle("sapF2CollapsedHeader",d,true)}};var f=e.extend("sap.m.Fiori20Adapter",{});f.attachViewChange=function(e,t){s.attachEvent("adaptedViewChange",e,t)};f.detachViewChange=function(e,t){s.detachEvent("adaptedViewChange",e,t)};f.traverse=function(e,t){d={aViewTitles:{},aViewSubTitles:{},aViewBackButtons:{}};g={};u=null;this._doBFS([{oNode:e,oAdaptOptions:t}]);var n=this._getCurrentlyAdaptedTopViewId();if(n&&a.byId(n)){this._fireViewChange(n,t)}};f._doBFS=function(e){var t=e.shift();if(!t){return}var n=t.oNode,a=t.oAdaptOptions,i=a.iSearchDepth;a=this._applyRules(a,n);if(!this._isAdaptationRequired(n,a)||i<=0){return}var o=this._isTopNavigableView(n);if(o){this._setAsCurrentlyAdaptedTopViewId(n.getId())}var s=this._processNode(n,a);var d=this._getNodeChildren(n),g=r.extend({},a,{iSearchDepth:this._updateSearchDepth(i,n)});if(s){var u=!!s.oTitleInfo,l=!!s.oBackButton,f=!!s.oStyledPage;g=r.extend(g,{bMoveTitle:a.bMoveTitle&&!u,bHideBackButton:a.bHideBackButton&&!l,bStylePage:a.bStylePage&&!f})}d.forEach(function(t){if(t){e.push({oNode:t,oAdaptOptions:g})}});this._doBFS(e)};f._processNode=function(e,t){this._attachDefferedAdaptationListeners(e,t);if(l._isAdaptableHeader(e)){return this._adaptHeader(e,t)}if(e.getParent()&&_(e.getParent(),"sap/m/NavContainer")){return this._getCachedViewInfoToMerge(e.getId())}};f._attachDefferedAdaptationListeners=function(e,t){this._attachAdaptableContentChange(e,t);this._attachNavigablePageChange(e,t);if(_(e,"sap/m/Page")||_(e,"sap/ui/core/mvc/XMLView")){this._observeAddAggregation(e,"content",t)}if(_(e,"sap/m/NavContainer")){this._observeRemoveAggregation(e,"pages",t)}if(t.bLateAdaptation===true&&_(e,"sap/m/Bar")){this._observeAddAggregation(e,"contentLeft",t,e);this._observeAddAggregation(e,"contentMiddle",t,e);this._observeAddAggregation(e,"contentRight",t,e)}if(_(e,"sap/ui/core/ComponentContainer")){var n=e.getComponentInstance();if(!n&&e.getName()&&!e.getDomRef()){var a=this;var i={onBeforeRendering:function(){e.removeEventDelegate(i);a._doBFS([{oNode:e.getComponentInstance(),oAdaptOptions:t}]);if(a._getCurrentlyAdaptedTopViewId()){a._fireViewChange(a._getCurrentlyAdaptedTopViewId(),t)}}};e.addEventDelegate(i,this)}}};f._checkHasListener=function(e,t){var n=g[e.getId()];return n&&n[t]};f._setHasListener=function(e,t,n){var a=g[e.getId()];if(!a){a={};g[e.getId()]=a}a[t]=n};f._attachAdaptableContentChange=function(e,t){if(typeof e._getAdaptableContent!=="function"){return}if(this._checkHasListener(e,"_adaptableContentChange")){return}var n=this._getCurrentlyAdaptedTopViewId(),i;var o=function(e){var o=e.getParameter("adaptableContent");this._setAsCurrentlyAdaptedTopViewId(n);this._doBFS([{oNode:o,oAdaptOptions:t}]);i=this._getCurrentlyAdaptedTopViewId();if(i&&a.byId(i)){this._fireViewChange(i,t)}}.bind(this);e.attachEvent("_adaptableContentChange",o);this._setHasListener(e,"_adaptableContentChange",o)};f._attachNavigablePageChange=function(e,t){if(!_(e,"sap/m/NavContainer")){return}if(this._checkHasListener(e,"navigate")){return}var n=function(e){var n,i=e.getParameter("to");t=this._applyRules(t,i);this._doBFS([{oNode:i,oAdaptOptions:t}]);n=this._getCurrentlyAdaptedTopViewId();if(n&&a.byId(n)){this._fireViewChange(n,t)}}.bind(this);e.attachNavigate(n);this._setHasListener(e,"navigate",n)};f._observeAddAggregation=function(e,t,i,o){if(this._checkHasListener(e,t)){return}var r=this._getCurrentlyAdaptedTopViewId(),s,d=function(e){var t=e.mutation,n=e.object;if(t==="add"||t==="insert"){this._setAsCurrentlyAdaptedTopViewId(r);this._doBFS([{oNode:o?o:n,oAdaptOptions:i}]);s=this._getCurrentlyAdaptedTopViewId();if(s&&a.byId(s)){this._fireViewChange(s,i)}}}.bind(this),g=new n(d);g.observe(e,{aggregations:[t]});this._setHasListener(e,t,g)};f._observeRemoveAggregation=function(e,t,a){if(this._checkHasListener(e,t)){return}var i=new n(this._onRemoveAggregation.bind(this));i.observe(e,{aggregations:[t]});this._setHasListener(e,t,i)};f._removeFromMergeInfo=function(e,t){Object.keys(e).forEach(function(n){var a=e[n];if(a.oControl===t||b(a.oControl,t)){this._detachAllListeners(a.oControl);delete e[n]}},this)};f._detachAllListeners=function(e){var t=g[e.getId()];if(!t){return}Object.keys(t).forEach(function(a){var i=t[a];if(i instanceof n){i.disconnect()}else{e.detachEvent(a,i)}delete t[a]})};f._onRemoveAggregation=function(e){var t=e.mutation,n;if(t==="remove"){n=e.child;this._detachAllListeners(n);this._removeFromMergeInfo(d.aViewTitles,n);this._removeFromMergeInfo(d.aViewSubTitles,n);this._removeFromMergeInfo(d.aViewBackButtons,n)}};f._getNodeChildren=function(e){if(typeof e._getAdaptableContent==="function"){var t=[e._getAdaptableContent()];if(_(e,"sap/m/Page")){t=t.concat(e.getContent())}return t}if(_(e,"sap/m/SplitContainer")){return[].concat(e.getAggregation("_navMaster"),e.getAggregation("_navDetail"))}if(_(e,"sap/uxap/ObjectPageLayout")){return[e.getHeaderTitle()]}if(_(e,"sap/ui/core/ComponentContainer")){return[e.getComponentInstance()]}if(_(e,"sap/ui/core/UIComponent")){return[e.getAggregation("rootControl")]}return e.findAggregatedObjects(false,C)};f._updateSearchDepth=function(e,t){if(_(t,"sap/ui/core/mvc/View")||_(t,"sap/ui/core/Component")||_(t,"sap/ui/core/ComponentContainer")){return e}return e-1};f._getTotalCachedInfoToMerge=function(e){var t=sap.ui.getCore().byId(e),n=this._getCachedViewInfoToMerge(e),a,o,r,s,d,g,u;if(!i.system.phone&&this._isTopSplitContainerSubView(t)){g=t.getParent();d=g&&g.getParent();if(d){a=d._oMasterNav&&d._oMasterNav.getId()===g.getId();o=d._oDetailNav&&d._oDetailNav.getId()===g.getId()}}if(a){r=d.getCurrentDetailPage();s=r&&r.getId();u=this._getCachedViewInfoToMerge(s);n=this._mergeSplitViewInfos(n,u)}if(o){r=d.getCurrentMasterPage();s=r&&r.getId();u=this._getCachedViewInfoToMerge(s);n=this._mergeSplitViewInfos(u,n)}n.sViewId=a||o?d.getId():e;return n};f._isTopSplitContainerSubView=function(e){var t=e&&e.getParent();return this._isTopmostNavContainer(t)&&_(t.getParent(),"sap/m/SplitContainer")};f._mergeSplitViewInfos=function(e,t){r.each(e,function(n,a){e[n]=a||t[n]});return e};f._getCachedViewInfoToMerge=function(e){var t=d.aViewBackButtons[e]?d.aViewBackButtons[e].oControl:undefined;return{oTitleInfo:d.aViewTitles[e],oSubTitleInfo:d.aViewSubTitles[e],oBackButton:t}};f._applyRules=function(e,t){var n=t.getParent();if(_(n,"sap/m/SplitContainer")){var a=i.system.phone,o=e.bMoveTitle,s=e.bHideBackButton;if(o){o=a}if(s&&!i.system.phone){s="initialPage"}return r.extend({},e,{bMoveTitle:o,bHideBackButton:s})}if(_(n,"sap/m/NavContainer")){if(e.bHideBackButton==="initialPage"){var d=n._getActualInitialPage()&&n._getActualInitialPage().getId()===t.getId();return r.extend({},e,{bHideBackButton:d})}}if(e.bMoveTitle===false||e.bHideBackButton===false){return r.extend({},e,{bCollapseHeader:false})}return e};f._getCurrentlyAdaptedTopViewId=function(){return u};f._setAsCurrentlyAdaptedTopViewId=function(e){u=e};f._isTopNavigableView=function(e){var t=e.getParent();return t&&this._isTopmostNavContainer(t)};f._isTopmostNavContainer=function(e){var t,n=e;while(n){if(_(n,"sap/m/NavContainer")){t=n}n=n.getParent()}return t&&t.getId()===e.getId()};f._adaptHeader=function(e,t){if(!e||!t){return}var n=new l(e,t),a=n.adapt();var i=this._getCurrentlyAdaptedTopViewId();if(a.oTitleInfo){d.aViewTitles[i]=a.oTitleInfo;this._registerTextChangeListener(d.aViewTitles,i,t)}if(a.oSubTitleInfo){d.aViewSubTitles[i]=a.oSubTitleInfo;this._registerTextChangeListener(d.aViewSubTitles,i,t)}if(a.oBackButtonInfo){if(a.oBackButtonInfo.oControl.getVisible()){d.aViewBackButtons[i]=a.oBackButtonInfo}this._registerVisibilityChangeListener(a.oBackButtonInfo,d.aViewBackButtons,i,t)}return a};f._registerTextChangeListener=function(e,t,n){var a=e[t];if(a&&a.oControl&&a.sChangeEventId){if(this._checkHasListener(a.oControl,a.sChangeEventId)){return}var i=function(a){var i=e[t];if(a.getParameter("name")!==i.sPropertyName){return}i.text=a.getParameter("newValue");this._fireViewChange(t,n)}.bind(this);a.oControl.attachEvent(a.sChangeEventId,i);this._setHasListener(a.oControl,a.sChangeEventId,i)}};f._registerVisibilityChangeListener=function(e,t,n,a){var i;if(e&&e.oControl&&e.sChangeEventId){if(this._checkHasListener(e.oControl,e.sChangeEventId)){return}var o=function(o){if(o.getParameter("name")!==e.sPropertyName){return}i=o.getParameter("newValue");if(!i){r.each(t,function(n,a){if(a.oControl.getId()===e.oControl.getId()){delete t[n]}})}var s=e.oControl.getParent();if(l._isAdaptableHeader(s)){f._adaptHeader(s,a);this._fireViewChange(n,a)}}.bind(this);e.oControl.attachEvent(e.sChangeEventId,o);this._setHasListener(e.oControl,e.sChangeEventId,o)}};f._fireViewChange=function(e,t){var n=this._getTotalCachedInfoToMerge(e);n.oAdaptOptions=t;s.fireEvent("adaptedViewChange",n)};f._isAdaptationRequired=function(e,t){if(!e||this._isNonAdaptableControl(e)){return false}for(var n in t){if(t.hasOwnProperty(n)&&(t[n]===true||t[n]==="initialPage")){return true}}return false};f._isNonAdaptableControl=function(e){return p(e)};function h(e){return c(e,["sap/m/Label","sap/m/Text","sap/m/Title"])}function p(e){return c(e,["sap/m/List","sap/m/Table","sap/ui/table/Table","sap/ui/table/TreeTable"])}function c(e,t){if(!e||!t){return}return t.some(function(t){return _(e,t)})}function _(e,t){var n=sap.ui.require(t);return n&&e instanceof n}function C(e){return e&&e.sParentAggregationName!=="dependents"}function v(e){return e&&typeof e.getVisible==="function"&&e.getVisible()===false}function b(e,t){var n=e&&e.getParent();while(n){if(n===t){return true}n=n.getParent()}return false}return f});