/*!
 * OpenUI5
 * (c) Copyright 2009-2023 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/uid","sap/ui/thirdparty/URI"],function(e,t,n,r,i,a){"use strict";var u=/&/g,o=/^\w+$/,f="sap.ui.model.odata.v4.lib._Helper",s=/\=/g,c=/%29/g,l=/%28/g,d=/%27/g,p=/^(\$auto(\.\w+)?|\$direct|\w+)$/,g=/#/g,h=/\([^/]*|\/-?\d+/g,y=/\+/g,$=/'/g,v=/''/g,m=/\s+/g,P;P={addByPath:function(e,t,n){if(n){if(!e[t]){e[t]=[n]}else if(!e[t].includes(n)){e[t].push(n)}}},addChildrenWithAncestor:function(e,t,n){if(t.length){e.forEach(function(e){var r;if(t.includes(e)){n[e]=true;return}r=e.split("/");r.pop();while(r.length){if(t.indexOf(r.join("/"))>=0){n[e]=true;break}r.pop()}})}},addToSelect:function(e,t){e.$select=e.$select||[];t.forEach(function(t){if(!e.$select.includes(t)){e.$select.push(t)}})},adjustTargets:function(e,t,n,r){var i=P.getAnnotationKey(e,".additionalTargets"),a;a=[e.target].concat(e[i]).map(function(e){return e&&P.getAdjustedTarget(e,t,n,r)}).filter(function(e){return e});e.target=a[0];if(i){e[i]=a.slice(1)}},adjustTargetsInError:function(e,t,n,r){if(!e.error){return}P.adjustTargets(e.error,t,n,r);if(e.error.details){e.error.details.forEach(function(e){P.adjustTargets(e,t,n,r)})}},aggregateExpandSelect:function(e,t){if(t.$select){P.addToSelect(e,t.$select)}if(t.$expand){e.$expand=e.$expand||{};Object.keys(t.$expand).forEach(function(n){if(e.$expand[n]){P.aggregateExpandSelect(e.$expand[n],t.$expand[n])}else{e.$expand[n]=t.$expand[n]}})}},buildPath:function(){var e="",t,n;for(n=0;n<arguments.length;n+=1){t=arguments[n];if(t||t===0){if(e&&e!=="/"&&t[0]!=="("){e+="/"}e+=t}}return e},buildQuery:function(e){var t,n;if(!e){return""}t=Object.keys(e);if(t.length===0){return""}n=[];t.forEach(function(t){var r=e[t];if(Array.isArray(r)){r.forEach(function(e){n.push(P.encodePair(t,e))})}else{n.push(P.encodePair(t,r))}});return"?"+n.join("&")},buildSelect:function(e){var t={};if(!e||e.includes("*")){return true}e.forEach(function(e){var n=e.split("/"),r=n.length-1,i=t;n.some(function(e,t){if(t===r||n[t+1]==="*"){i[e]=true;return true}if(i[e]===true){return true}i=i[e]=i[e]||{}})});return t},checkGroupId:function(e,t,n){if(!t&&e===undefined||typeof e==="string"&&(t?o:p).test(e)){return}throw new Error((n||"Invalid group ID: ")+e)},clone:function e(t,n,r){var i;if(t===undefined||t===Infinity||t===-Infinity||Number.isNaN(t)){return t}i=JSON.stringify(t,n);return r?i:JSON.parse(i)},convertExpandSelectToPaths:function(e){var t=[];function n(e,r){if(e.$select){e.$select.forEach(function(e){t.push(P.buildPath(r,e))})}if(e.$expand){Object.keys(e.$expand).forEach(function(t){n(e.$expand[t],P.buildPath(r,t))})}}n(e,"");return t},copyPrivateAnnotation:function(e,t,n){if(P.hasPrivateAnnotation(e,t)){if(P.hasPrivateAnnotation(n,t)){throw new Error("Must not overwrite: "+t)}P.setPrivateAnnotation(n,t,P.getPrivateAnnotation(e,t))}},createError:function(t,n,r,i){var a=t.responseText,u=t.getResponseHeader("Content-Type"),o,s=new Error(n+": "+t.status+" "+t.statusText),c=t.getResponseHeader("Retry-After"),l;s.status=t.status;s.statusText=t.statusText;s.requestUrl=r;s.resourcePath=i;if(t.status===0){s.message="Network error";return s}if(u){u=u.split(";")[0]}if(t.status===412){o=t.getResponseHeader("Preference-Applied");if(o&&o.replace(m,"")==="handling=strict"){s.strictHandlingFailed=true}else{s.isConcurrentModification=true}}if(c){l=parseInt(c);s.retryAfter=new Date(Number.isNaN(l)?c:Date.now()+l*1e3)}if(u==="application/json"){try{s.error=JSON.parse(a).error;s.message=s.error.message;if(typeof s.message==="object"){s.message=s.error.message.value}}catch(t){e.warning(t.toString(),a,f)}}else if(u==="text/plain"){s.message=a}return s},createGetMethod:function(e,t){return function(){var n=this[e].apply(this,arguments);if(n.isFulfilled()){return n.getResult()}else if(t){if(n.isRejected()){n.caught();throw n.getResult()}else{throw new Error("Result pending")}}}},createMissing:function(e,t){t.reduce(function(e,n,r){if(!(n in e)){e[n]=r+1<t.length?{}:null}return e[n]},e)},createRequestMethod:function(e){return function(){return Promise.resolve(this[e].apply(this,arguments))}},createTechnicalDetails:function(e){var t,n=e["@$ui5.error"],r=e["@$ui5.originalMessage"]||e,i={};if(n&&(n.status||n.cause)){n=n.cause||n;i.httpStatus=n.status;if(n.isConcurrentModification){i.isConcurrentModification=true}if(n.retryAfter){i.retryAfter=n.retryAfter}}if(!(r instanceof Error)){Object.defineProperty(i,"originalMessage",{enumerable:true,get:function(){if(!t){t=P.publicClone(r)}return t}})}return i},decomposeError:function(e,t,n){var r=e.error.details&&e.error.details.map(function(e){return P.getContentID(e)}),i=P.getContentID(e.error);return t.map(function(t,a){var u=new Error(e.message);function o(e,n){if(a===0&&!n){if(e.target){e.message=e.target+": "+e.message}delete e.target;return true}return n===t.$ContentID}u.error=P.clone(e.error);u.requestUrl=n+t.url;u.resourcePath=t.$resourcePath;u.status=e.status;u.statusText=e.statusText;if(!o(u.error,i)){u.error.$ignoreTopLevel=true}else{u.strictHandlingFailed=e.strictHandlingFailed}if(u.error.details){u.error.details=u.error.details.filter(function(e,t){return o(e,r[t])})}return u})},deepEqual:t,deletePrivateAnnotation:function(e,t){var n=e["@$ui5._"];if(n){delete n[t]}},deleteUpdating:function(e,t){var n=t;e.split("/").some(function(e){var t=n[e];if(t===null||Array.isArray(t)){return true}if(typeof t==="object"){n=t;return false}delete n[e+"@$ui5.updating"]})},drillDown:function(e,t){return t.reduce(function(e,t){return e&&t in e?e[t]:undefined},e)},encode:function(e,t){var n=encodeURI(e).replace(u,"%26").replace(g,"%23").replace(y,"%2B");if(t){n=n.replace(s,"%3D")}return n},encodePair:function(e,t){return P.encode(e,true)+"="+P.encode(t,false)},extractMessages:function(e){var t=[];function n(n,r,i){var a={additionalTargets:P.getAdditionalTargets(n),code:n.code,message:n.message,numericSeverity:r,technical:i||n.technical,"@$ui5.error":e,"@$ui5.originalMessage":n};Object.keys(n).forEach(function(t){if(t[0]==="@"){if(t.endsWith(".numericSeverity")){a.numericSeverity=n[t]}else if(t.endsWith(".longtextUrl")&&e.requestUrl&&n[t]){a.longtextUrl=P.makeAbsolute(n[t],e.requestUrl)}}});if(typeof n.target==="string"){if(n.target[0]==="$"||!e.resourcePath){a.message=n.target+": "+n.message}else{a.target=n.target}}a.transition=true;t.push(a)}if(e.error){if(!e.error.$ignoreTopLevel){n(e.error,4,true)}if(e.error.details){e.error.details.forEach(function(e){n(e)})}}else{n(e,4,true)}return t},extractMergeableQueryOptions:function(e){var t={};if("$expand"in e){t.$expand=e.$expand;e.$expand="~"}if("$select"in e){t.$select=e.$select;e.$select="~"}return t},fetchPropertyAndType:function(e,t){return e(t).then(function(n){if(n&&n.$kind==="NavigationProperty"){return e(t+"/").then(function(){return n})}return n})},filterPaths:function(e,t){return t.filter(function(t){var n=P.getMetaPath(t);return e.every(function(e){return!P.hasPathPrefix(n,e)})})},fireChange:function(e,t,n,r){var i=e[t],a;if(i){for(a=0;a<i.length;a+=1){i[a].onChange(n,r)}}},fireChanges:function(e,t,n,r){Object.keys(n).forEach(function(i){var a=P.buildPath(t,i),u=n[i];if(u&&typeof u==="object"){P.fireChanges(e,a,u,r)}else{P.fireChange(e,a,r?undefined:u)}});P.fireChange(e,t,r?undefined:n)},formatLiteral:function(e,t){if(e===undefined){throw new Error("Illegal value: undefined")}if(e===null){return"null"}switch(t){case"Edm.Binary":return"binary'"+e+"'";case"Edm.Boolean":case"Edm.Byte":case"Edm.Double":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":case"Edm.Single":return String(e);case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return e;case"Edm.Duration":return"duration'"+e+"'";case"Edm.String":return"'"+String(e).replace($,"''")+"'";default:throw new Error("Unsupported type: "+t)}},getAdditionalTargets:function(e){return P.getAnnotation(e,".additionalTargets")},getAdjustedTarget:function(e,t,n,r){var i,a,u;u=e.split("/");a=u.shift();if(a==="$Parameter"){e=u.join("/");a=u.shift()}if(t.$IsBound&&a===t.$Parameter[0].$Name){e=P.buildPath(r,u.join("/"));return e}i=t.$Parameter.some(function(e){return a===e.$Name});if(i){e=n+"/"+e;return e}},getAnnotation:function(e,t){var n=P.getAnnotationKey(e,t);return n&&e[n]},getAnnotationKey:function(t,n,r){var i,a,u=(r||"")+"@";Object.keys(t).forEach(function(t){if(t.startsWith(u)&&t.endsWith(n)){if(i){e.warning("Cannot distinguish "+i+" from "+t,undefined,f);a=true}i=t}});return a?undefined:i},getContentID:function(e){return P.getAnnotation(e,".ContentID")},getKeyFilter:function(e,t,n,r){var i=[],a,u=P.getKeyProperties(e,t,n,r);if(!u){return undefined}for(a in u){i.push(a+" eq "+u[a])}return i.join(" and ")},getKeyPredicate:function(e,t,n,r,i){var a=P.getKeyProperties(e,t,n,r,true);if(!a){return undefined}r=Object.keys(a).map(function(e,t,n){var r=encodeURIComponent(a[e]);return i||n.length>1?encodeURIComponent(e)+"="+r:r});return"("+r.join(",")+")"},getKeyProperties:function(e,t,n,r,i){var a,u={};r=r||n[t].$Key;a=r.some(function(r){var a,o,f,s,c,l,d;if(typeof r==="string"){a=o=r}else{a=Object.keys(r)[0];o=r[a];if(!i){a=o}}c=o.split("/");s=c.pop();f=P.drillDown(e,c);d=f[s];if(d===undefined||s+"@odata.type"in f){return true}l=n[P.buildPath(t,c.join("/"))];d=P.formatLiteral(d,l[s].$Type);u[a]=d});return a?undefined:u},getMetaPath:function(e){if(e[0]==="/"){return e.replace(h,"")}if(e[0]!=="("){e="/"+e}return e.replace(h,"").slice(1)},getPredicates:function(e){var t,n=e.map(r);function r(e){var n=P.getPrivateAnnotation(e.getValue(),"predicate");if(!n){t=true}return n}return t?null:n},getPredicateIndex:function(e){var t=e?e.indexOf("(",e.lastIndexOf("/")):-1;if(t<0||!e.endsWith(")")){throw new Error("Not a list context path to an entity: "+e)}return t},getPrivateAnnotation:function(e,t){var n=e["@$ui5._"];return n&&n[t]},getQueryOptionsForPath:function(e,t){t=P.getMetaPath(t);if(t){t.split("/").some(function(t){e=e&&e.$expand&&e.$expand[t];if(!e||e===true){e={};return true}})}return e||{}},getRelativePath:function(e,t){if(t.length){if(!e.startsWith(t)){return undefined}e=e.slice(t.length);if(e){if(e[0]==="/"){return e.slice(1)}if(e[0]!=="("){return undefined}}}return e},hasPrivateAnnotation:function(e,t){var n=e["@$ui5._"];return n?t in n:false},informAll:function(e,t,n,r){if(r===n){return}if(r&&typeof r==="object"){Object.keys(r).forEach(function(i){P.informAll(e,P.buildPath(t,i),n&&n[i],r[i])})}else{P.fireChange(e,t,r===undefined?null:r);r={}}if(n&&typeof n==="object"){Object.keys(n).forEach(function(i){if(!r.hasOwnProperty(i)){P.informAll(e,P.buildPath(t,i),n[i],undefined)}})}},inheritPathValue:function(e,t,n){e.forEach(function(r,i){var a=!(r in n);if(i+1<e.length){if(a){n[r]={}}t=t[r];n=n[r]}else if(a){n[r]=t[r]}})},intersectQueryOptions:function(e,t,r,i,a,u){var o=[],f={},s=u&&r(i+"/@com.sap.vocabularies.Common.v1.Messages/$Path").getResult(),c,l,d,p={};function g(e,t){var n=t.split("/");return n.every(function(t,a){return a===0&&e||t==="$count"||r(i+"/"+n.slice(0,a+1).join("/")).getResult().$kind==="Property"})}if(t.indexOf("")>=0){throw new Error("Unsupported empty navigation property path")}if(t.indexOf("*")>=0){d=(e&&e.$select||[]).slice();if(s&&!d.includes(s)){d.push(s)}}else if(e&&e.$select&&e.$select.indexOf("*")<0){P.addChildrenWithAncestor(t,e.$select,p);P.addChildrenWithAncestor(e.$select,t,p);if(s&&t.includes(s)){p[s]=true}d=Object.keys(p).filter(g.bind(null,true))}else{d=t.filter(g.bind(null,false))}if(e&&e.$expand){o=Object.keys(e.$expand);o.forEach(function(u){var o,s=i+"/"+u,c=P.buildPath(a,u),l={},d;P.addChildrenWithAncestor([u],t,l);if(!n(l)){f[u]=e.$expand[u];return}d=P.stripPathPrefix(u,t);if(d.length){if(r(s).getResult().$isCollection){throw new Error("Unsupported collection-valued navigation property "+s)}o=P.intersectQueryOptions(e.$expand[u]||{},d,r,s,c);if(o){f[u]=o}}})}if(!d.length&&n(f)){return null}c=Object.assign({},e,{$select:d});l=r(i).getResult();if(l.$kind==="NavigationProperty"&&!l.$isCollection){P.selectKeyProperties(c,r(i+"/").getResult())}if(n(f)){delete c.$expand}else{c.$expand=f}return c},hasPathPrefix:function(e,t){return P.getRelativePath(e,t)!==undefined},isDataAggregation:function(e){return e&&e.$$aggregation&&!e.$$aggregation.hierarchyQualifier},isSafeInteger:function(e){if(typeof e!=="number"||!isFinite(e)){return false}e=Math.abs(e);return e<=9007199254740991&&Math.floor(e)===e},isSelected:function(e,t){var n,r;if(!t){return false}if(t.$expand){for(n in t.$expand){r=P.getRelativePath(e,n);if(r){return P.isSelected(r,t.$expand[n])}}}return!t.$select||t.$select.includes("*")||t.$select.some(function(t){return P.hasPathPrefix(e,t)})},makeAbsolute:function(e,t){return new a(e).absoluteTo(t).toString().replace(d,"'").replace(l,"(").replace(c,")")},merge:r,mergeQueryOptions:function(e,t,n){var r;function i(t,n){if(n&&(!e||e[t]!==n)){if(!r){r=e?P.clone(e):{}}r[t]=n}}i("$orderby",t);if(n){i("$filter",n[0]);i("$$filterBeforeAggregate",n[1])}return r||e},namespace:function(e){var t;e=e.split("/")[0].split("(")[0];t=e.lastIndexOf(".");return t<0?"":e.slice(0,t)},parseLiteral:function(e,t,n){function r(r){if(!isFinite(r)){throw new Error(n+": Not a valid "+t+" literal: "+e)}return r}if(e==="null"){return null}switch(t){case"Edm.Boolean":return e==="true";case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.SByte":return r(parseInt(e));case"Edm.Date":case"Edm.DateTimeOffset":case"Edm.Decimal":case"Edm.Guid":case"Edm.Int64":case"Edm.TimeOfDay":return e;case"Edm.Double":case"Edm.Single":return e==="INF"||e==="-INF"||e==="NaN"?e:r(parseFloat(e));case"Edm.String":return e.slice(1,-1).replace(v,"'");default:throw new Error(n+": Unsupported type: "+t)}},publicClone:function(e,t,n){return P.clone(e,function(e,n){if(t?!e.startsWith("@$ui5."):e!=="@$ui5._"){return n}},n)},removeByPath:function(e,t,n){var r=e[t],i;if(r){i=r.indexOf(n);if(i>=0){if(r.length===1){delete e[t]}else{r.splice(i,1)}}}},resetInactiveEntity:function(e,t,n){var r=P.getPrivateAnnotation(n,"initialData"),i=P.getPrivateAnnotation(n,"postBody");Object.keys(i).forEach(function(a){if(a in r){n[a]=i[a]=r[a]}else{delete i[a];delete n[a]}P.fireChange(e,t+"/"+a,n[a])});P.updateAll(e,t,n,{"@$ui5.context.isInactive":true});P.getPrivateAnnotation(n,"context").setInactive()},resolveIfMatchHeader:function(e,t){var n=e&&e["If-Match"];if(n&&typeof n==="object"){n=n["@odata.etag"];e=Object.assign({},e);if(n===undefined){delete e["If-Match"]}else{e["If-Match"]=t?"*":n}}return e},restoreUpdatingProperties:function(e,t){var n=t||{};Object.keys(e||{}).forEach(function(r){if(r.startsWith("@")){return}if(Array.isArray(e[r])){return}if(typeof e[r]==="object"){n[r]=P.restoreUpdatingProperties(e[r],n[r])}if(e[r+"@$ui5.updating"]){n[r]=e[r];n[r+"@$ui5.updating"]=e[r+"@$ui5.updating"];t=n}});return t},selectKeyProperties:function(e,t){if(t&&t.$Key){P.addToSelect(e,t.$Key.map(function(e){if(typeof e==="object"){return e[Object.keys(e)[0]]}return e}))}},setAnnotation:function(e,t,n){if(n!==undefined){e[t]=n}else{delete e[t]}},setLanguage:function(e,t){if(t&&!e.includes("?sap-language=")&&!e.includes("&sap-language=")){e+=(e.includes("?")?"&":"?")+"sap-language="+P.encode(t)}return e},setPrivateAnnotation:function(e,t,n){var r=e["@$ui5._"];if(!r){r=e["@$ui5._"]={}}r[t]=n},stripPathPrefix:function(e,t){var n=e+"/";if(e===""){return t}return t.filter(function(t){return t===e||t.startsWith(n)}).map(function(e){return e.slice(n.length)})},toArray:function(e){if(e===undefined||e===null){return[]}if(Array.isArray(e)){return e.slice()}return[e]},uid:i,updateAll:function(e,t,n,r){Object.keys(r).forEach(function(i){var a=P.buildPath(t,i),u=r[i],o=n[i];if(i==="@$ui5._"){P.setPrivateAnnotation(n,"predicate",P.getPrivateAnnotation(r,"predicate"))}else if(Array.isArray(u)){n[i]=u}else if(u&&typeof u==="object"){n[i]=P.updateAll(e,a,o||{},u)}else if(o!==u){n[i]=u;if(o&&typeof o==="object"){P.fireChanges(e,a,o,true)}else{P.fireChange(e,a,u)}}});return n},updateExisting:function(e,t,n,r){if(!r){return}Object.keys(n).forEach(function(i){var a=P.buildPath(t,i),u=n[i],o=r[i];if(i in r||i[0]==="#"){if(Array.isArray(o)){n[i]=o}else if(o&&typeof o==="object"){if(u){P.updateExisting(e,a,u,o)}else{n[i]=o;P.fireChanges(e,a,o,false)}}else if(u!==o){n[i]=o;if(u&&typeof u==="object"){P.fireChanges(e,a,u,true)}else{P.fireChange(e,a,o)}}}});Object.keys(r).filter(function(e){return e[0]==="#"}).filter(function(e){return!(e in n)}).forEach(function(i){var a=r[i],u=P.buildPath(t,i);n[i]=a;P.fireChanges(e,u,a,false)})},updateNonExisting:function(e,t){Object.keys(t).forEach(function(n){var r=t[n],i;if(n in e){i=e[n];if(r&&i&&typeof r==="object"&&!Array.isArray(r)){P.updateNonExisting(i,r)}}else{e[n]=r}})},updateSelected:function(e,t,n,r,i,a,u){function o(e,t){var n;if(e===true){return true}if(e[t]){return e[t]}n=t.indexOf("@");if(n===0||n>0&&e[t.slice(0,n)]){return true}}function f(t,n,r,i){Object.keys(r).forEach(function(a){if(!(a in i)&&a.includes("@")&&!a.startsWith("@$ui5.")&&o(n,a)&&!a.endsWith("@$ui5.updating")){delete r[a];P.fireChange(e,P.buildPath(t,a),undefined)}});Object.keys(i).forEach(function(u){var s=P.buildPath(t,u),c=o(n,u),l,d=i[u],p,g=r[u];if(!c){return}if(u==="@$ui5._"){l=P.getPrivateAnnotation(i,"predicate");if(a&&a(t)){p=P.getPrivateAnnotation(r,"predicate");if(l!==p){throw new Error("Key predicate of '"+t+"' changed from "+p+" to "+l)}}else{P.setPrivateAnnotation(r,"predicate",l)}}else if(Array.isArray(d)){r[u]=d}else if(d&&typeof d==="object"&&!u.includes("@")){r[u]=f(s,c,g||{},d)}else if(g!==d&&!r[u+"@$ui5.updating"]){r[u]=d;if(g&&typeof g==="object"){P.fireChanges(e,s,g,true)}else if(c===true){P.fireChange(e,s,d)}}});if(u){return r}Object.keys(n).forEach(function(n){if(!(n in r)&&n!=="*"){r[n+"@$ui5.noData"]=true;P.fireChange(e,P.buildPath(t,n),undefined,true)}});return r}f(t,P.buildSelect(i),n,r)},updateTransientPaths:function(e,t,n){var r;for(r in e){if(r.includes(t)){e[r.replace(t,n)]=e[r];delete e[r]}}},wrapChildQueryOptions:function(t,n,r,i){var a="",u=n.split("/"),o,s=t,c={},l=c,d;if(n===""){return r}for(d=0;d<u.length;d+=1){s=P.buildPath(s,u[d]);a=P.buildPath(a,u[d]);if(u[d].endsWith("*")){o=null;continue}o=i(s).getResult();if(o.$kind==="NavigationProperty"){l.$expand={};l=l.$expand[a]=d===u.length-1?r:{};P.selectKeyProperties(l,i(s+"/").getResult());a=""}else if(o.$kind!=="Property"){return undefined}}if(!o||o.$kind==="Property"){if(Object.keys(r).length>0){e.error("Failed to enhance query options for auto-$expand/$select as the"+" child binding has query options, but its path '"+n+"' points to a structural property",JSON.stringify(r),f);return undefined}P.addToSelect(l,[a])}if("$apply"in r){e.debug("Cannot wrap $apply into $expand: "+n,JSON.stringify(r),f);return undefined}return c}};return P},false);